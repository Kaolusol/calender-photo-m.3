<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRC LIVE M.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling if content is long */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            margin: 0; /* Ensure no default body margin */
        }

        /* Custom Styles for Pre-App Screen (Login Screen) */
        #preAppScreen {
            display: flex;
            flex-direction: column; /* Allow content to stack vertically */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f8f9fa; /* Light background */
            position: fixed; /* Keep it on top */
            width: 100%;
            height: 100%;
            top: 0;
            left: 0; 
            z-index: 1050; /* Above modals */
        }
        .start-container {
            text-align: center;
            background: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15); /* More pronounced shadow */
        }
        .start-logo {
            margin-bottom: 20px;
            display: flex; /* Make it a flex container */
            justify-content: center; /* Center content horizontally */
        }
        .start-logo img {
            max-width: 150px; /* Adjust as needed */
            height: auto;
        }
        .footer-preapp { /* Specific class for footer on preAppScreen */
            position: absolute; /* Position absolutely within preAppScreen */
            bottom: 20px; /* Distance from the bottom */
            left: 0; /* Align to the very left edge */
            width: 100%; /* Take full width */
            text-align: left; /* Align text to the left */
            padding-left: 20px; /* Small padding from the left edge */
            box-sizing: border-box; /* Include padding in the width calculation */
            font-size: 0.85em;
            color: #6c757d;
        }

        /* Calendar App Styles (Main App) */
        #calendarAppMain { /* New ID for the main calendar content wrapper */
            display: none; /* Hidden by default, shown after login */
            width: 100%;
            display: flex; /* Use flex to center the calendar-container */
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            box-sizing: border-box;
        }

        .calendar-container {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 1.5rem; /* p-6 */
            width: 100%;
            max-width: 900px; /* max-w-3xl */
        }
        .calendar-header {
            display: flex;
            justify-content: space-between; /* Distribute items with space between them */
            align-items: center;
            margin-bottom: 1.5rem; /* mb-6 */
            position: relative; /* Needed for absolute positioning if used, but flex is handling it now */
        }
        .calendar-header h2 {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Tailwind gray-900 */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* gap-2 */
            text-align: center;
        }
        .day-name {
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* Tailwind gray-600 */
            padding: 0.5rem; /* p-2 */
        }
        .day {
            background-color: #f9fafb; /* Tailwind gray-50 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            min-height: 80px; /* Ensure consistent height for days */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .day:hover {
            background-color: #e5e7eb; /* Tailwind gray-200 */
        }
        .day.current-month {
            background-color: #ffffff;
        }
        .day.today {
            background-color: #bfdbfe; /* Tailwind blue-200 */
            border: 2px solid #3b82f6; /* Tailwind blue-500 */
            font-weight: 700;
        }
        .day.selected {
            background-color: #a7f3d0; /* Tailwind emerald-200 */
            border: 2px solid #10b981; /* Tailwind emerald-500 */
        }
        .day.other-month {
            color: #9ca3af; /* Tailwind gray-400 */
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .day-number {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* Tailwind gray-900 */
        }
        .day.other-month .day-number {
            color: #9ca3af; /* Tailwind gray-400 */
        }
        /* Event indicators on calendar day */
        .event-indicators {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            align-items: center;
            gap: 4px; /* small gap between dot and count */
        }
        .event-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            /* background-color will be set by JS */
        }
        .event-count {
            font-size: 0.75rem; /* text-xs */
            /* background-color will be set by JS, removed fixed red */
            color: white;
            border-radius: 9999px; /* rounded-full */
            padding: 0.125rem 0.375rem; /* px-1.5 py-0.5 */
        }


        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem; /* p-8 */
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            width: 90%;
            max-width: 500px;
            /* Added max-height and overflow for scrollability */
            max-height: 90vh; /* Set a maximum height to prevent overflow on small screens */
            overflow-y: auto; /* Enable vertical scrolling if content exceeds max-height */
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .modal-header h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: #1f2937;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280; /* Tailwind gray-500 */
        }
        .form-group {
            margin-bottom: 1rem; /* mb-4 */
        }
        .form-group label {
            display: block;
            font-weight: 500; /* font-medium */
            color: #374151; /* Tailwind gray-700 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem; /* p-3 */
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem;
            color: #1f2937;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6; /* Tailwind blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ring-blue-200 */
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem; /* gap-3 */
            margin-top: 1.5rem; /* mt-6 */
        }
        .btn {
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
        }
        .btn-primary {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.1);
        }
        .btn-secondary {
            background-color: #6b7280; /* Tailwind gray-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
            box-shadow: 0 4px 6px -1px rgba(107, 114, 128, 0.3), 0 2px 4px -1px rgba(107, 114, 128, 0.1);
        }
        .btn-danger {
            background-color: #ef4444; /* Tailwind red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Tailwind red-600 */
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3), 0 2px 4px -1px rgba(239, 68, 68, 0.1);
        }

        /* Event List in Modal */
        .event-list {
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb; /* Tailwind gray-200 */
            padding-top: 1.5rem;
        }
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .event-item:last-child {
            margin-bottom: 0;
        }
        .event-details {
            flex-grow: 1;
        }
        .event-details h4 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .event-details p {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .event-edit-btn, .event-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            transition: color 0.2s ease-in-out;
        }
        .event-edit-btn {
            color: #3b82f6; /* Tailwind blue-500 */
            margin-right: 0.5rem;
        }
        .event-edit-btn:hover {
            color: #2563eb; /* Tailwind blue-600 */
        }
        .event-delete-btn {
            color: #ef4444; /* Tailwind red-500 */
        }
        .event-delete-btn:hover {
            color: #dc2626;
        }
        .no-events-message {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 1rem;
        }

        /* Custom styles for the password input group */
        .password-input-group {
            position: relative;
            width: 100%;
            max-width: 400px; /* Adjusted max-width for size in image */
            height: 55px; /* Adjusted height for size in image */
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #d1d5db; /* Default border color */
            border-radius: 0.75rem; /* More rounded corners */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Ensure padding is included in width */
            display: flex; /* Use flexbox to align content within the group */
            align-items: center; /* Vertically center items */
            padding-right: 1rem; /* Padding on the right for the icon */
        }

        .password-input-group:focus-within { /* When any child within the group is focused */
            border-color: #000000; /* Black on focus */
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1); /* Subtle black shadow on focus */
        }

        .password-input {
            flex-grow: 1; /* Allow input to take remaining space */
            height: 100%; /* Fill parent height */
            padding: 0.75rem 0 0.75rem 1.25rem; /* Padding for placeholder text */
            font-size: 1.15rem; /* Adjusted font size for placeholder/input text */
            border: none; /* Remove default input border */
            background-color: transparent; /* Make input background transparent */
            color: #1f2937;
            outline: none; /* Remove focus outline */
            border-radius: 0.75rem; /* Rounded corners (though covered by parent) */
            box-sizing: border-box;
        }
        /* Style for the placeholder text */
        .password-input::placeholder {
            color: #6b7280; /* Gray color for placeholder */
            opacity: 1; /* Ensure placeholder is always visible */
        }

        .password-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 1.3rem; /* Adjusted icon size */
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        /* Adjust padding for the error message */
        #passwordFeedback {
            padding-left: 1rem; /* Align with input text */
        }

        /* New style for calendar title on main app */
        .main-calendar-title {
            text-align: center;
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Tailwind gray-900 */
            font-size: 2rem; /* text-4xl */
            margin-bottom: 1.5rem; /* mb-6 */
        }

        /* Style for the new "Back to Website" button */
        .back-to-website-button {
            background-color: #60a5fa; /* Tailwind blue-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            /* Removed margin-top and auto margins, now managed by flexbox */
        }

        .back-to-website-button:hover {
            background-color: #3b82f6; /* Tailwind blue-500 */
            box-shadow: 0 4px 6px -1px rgba(96, 165, 250, 0.3), 0 2px 4px -1px rgba(96, 165, 250, 0.1);
        }

        /* Google Sign-in button style */
        .btn-google {
            background-color: #4285F4; /* Google blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-google:hover {
            background-color: #357ae8;
            box-shadow: 0 4px 6px -1px rgba(66, 133, 244, 0.3), 0 2px 4px -1px rgba(66, 133, 244, 0.1);
        }

        /* Loading Indicator Styles */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(243, 244, 246, 0.8); /* Semi-transparent gray-100 */
            display: flex;
            flex-direction: column; /* To stack text and spinner */
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Above modals */
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            transition: opacity 0.3s ease;
        }
        #loadingIndicator.hidden {
            opacity: 0;
            pointer-events: none; /* Allow clicks through when hidden */
        }

        /* Spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6; /* Blue spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem; /* Space between spinner and text */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* User ID Display */
        #userIdDisplay {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #4b5563;
            z-index: 999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none; /* Hide by default, only show if useful for debug */
        }

        #signOutButton {
            position: absolute;
            top: 1.5rem; /* Same as calendar-container padding */
            right: 1.5rem; /* Same as calendar-container padding */
            z-index: 10; /* Ensure it's above other elements if needed */
        }
    </style>
</head>
<body>
    <div id="preAppScreen">
        <div class="start-container">
            <div class="start-logo">
                <img src="S__30875655.jpg" alt="PRC LIVE M.3 Logo">
            </div>
            <h1 class="font-extrabold text-3xl mb-1">PRC LIVE M.3</h1>
            <p class="text-gray-700 text-lg mb-2">LIVE AND PHOTOGRAPHY</p>
            <p class="text-gray-500 text-sm italic">By The Prince Royal's College M.3</p>
            
            <div class="mb-3 mt-4 password-input-group">
                <input type="password" class="password-input" id="passwordInput" placeholder="กรอกรหัสผ่าน">
                <button type="button" class="password-toggle-btn" id="togglePasswordVisibility">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
            <div class="text-red-500 text-sm mt-1 hidden" id="passwordFeedback">
                รหัสผ่านไม่ถูกต้อง
            </div>
            <button class="btn btn-primary text-lg mt-3" id="startButton">เข้าสู่ระบบด้วยรหัสผ่าน</button>
            
            <div class="mt-4 text-gray-500">หรือ</div>
            <button class="btn-google text-lg mt-3" id="googleSignInButton">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" alt="Google logo" class="w-5 h-5">
                เข้าสู่ระบบด้วย Google
            </button>
        </div>
        <div class="footer-preapp">
            <span class="text-muted">V. 1.0.0 power by AI from Photo Team M.3</span>
        </div>
    </div>

    <div id="calendarAppMain">
        <div class="calendar-container">
            <button class="btn btn-secondary" id="signOutButton">ออกจากระบบ</button>
            <div class="main-calendar-title">📅 ปฏิทินการปฏิบัติหน้าที่ของทีมช่างภาพ ม.3 📅</div>
            <div class="calendar-header">
                <div class="flex items-center gap-4">
                    <button id="prevMonth" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="bi bi-chevron-left"></i></button>
                    <h2 id="currentMonthYear"></h2>
                    <button id="nextMonth" class="btn btn-secondary px-4 py-2 rounded-lg"><i class="bi bi-chevron-right"></i></button>
                </div>
                <button class="back-to-website-button" id="backToWebsiteBtn">กลับเข้าเว็บทีมช่างภาพ</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                </div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">งานสำหรับวันที่</h3>
                <button class="modal-close-btn" id="closeModal">&times;</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventDate">
                <div class="form-group">
                    <label for="eventTitle">ชื่องาน <span class="text-red-500">*</span></label>
                    <input type="text" id="eventTitle" placeholder="เช่น ประชุมทีม" required class="rounded-lg">
                </div>
                <div class="form-group">
                    <label for="eventBookerName">ชื่อผู้จอง <span class="text-red-500">*</span></label>
                    <input type="text" id="eventBookerName" placeholder="เช่น นายสมชาย" required class="rounded-lg">
                </div>
                <div class="form-group">
                    <label for="eventTime">เวลา (ไม่บังคับ)</label>
                    <input type="time" id="eventTime" class="rounded-lg">
                </div>
                <div class="form-group">
                    <label for="eventDescription">รายละเอียด (ไม่บังคับ)</label>
                    <textarea id="eventDescription" rows="3" placeholder="รายละเอียดเพิ่มเติมเกี่ยวกับงาน" class="rounded-lg"></textarea>
                </div>
                <div class="form-group">
                    <label class="block font-medium text-gray-700 mb-2">สีของงาน</label>
                    <div id="eventColorSelection" class="flex flex-wrap gap-2 justify-center">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancelAddEvent" class="btn btn-secondary">ยกเลิก</button>
                    <button type="submit" id="addEventButton" class="btn btn-primary">เพิ่มงาน</button>
                </div>
            </form>

            <div class="event-list" id="currentDayEvents">
                <h4>รายการงานสำหรับวันนี้</h4>
                </div>
        </div>
    </div>

    <div id="customMessageModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customMessageTitle"></h3>
                <button class="modal-close-btn" id="closeCustomMessageModal">&times;</button>
            </div>
            <div class="modal-body text-gray-700 mb-4" id="customMessageBody"></div>
            <div class="modal-footer justify-end gap-3" id="customMessageFooter">
                </div>
        </div>
    </div>

    <div id="loadingIndicator" class="hidden">
        <div class="spinner"></div>
        กำลังโหลด...
    </div>

    <div id="userIdDisplay"></div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const ACCESS_PASSWORD = '124356'; // รหัสผ่านสำหรับเข้าสู่ระบบ (ยังคงใช้ได้สำหรับ admin)
        const TEAM_WEBSITE_URL = 'https://prc-m3-photo-team.carrd.co/#staff-check-f'; // URL ของเว็บไซต์ทีมช่างภาพ
        const SHARED_EVENTS_COLLECTION_PATH = "shared_team_events"; // ชื่อ Collection ใหม่สำหรับข้อมูลที่แชร์กัน

        // Firebase Configuration (from user's provided data)
        const firebaseConfig = {
            apiKey: "AIzaSyDfNe8kGSTpXOO3lU8A-bH6ZClWVKy_BYc",
            authDomain: "calender-photo-m3.firebaseapp.com",
            projectId: "calender-photo-m3",
            storageBucket: "calender-photo-m3.firebasestorage.app",
            messagingSenderId: "797847204359",
            appId: "1:797847204359:web:5f1743233f9c537f9130a2"
        };
        // Use global __app_id and __firebase_config if available from Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Fallback to projectId if __app_id is not defined
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;


        // Firebase variables
        let app;
        let db;
        let auth;
        let currentUserId = null; // ยังคงเก็บ userId ไว้ แต่ไม่ได้ใช้ใน Firestore Path สำหรับ Shared Data แล้ว
        let isFirebaseReady = false;

        // Pre-App (Login) Screen Elements
        const preAppScreen = document.getElementById('preAppScreen');
        const passwordInput = document.getElementById('passwordInput');
        const togglePasswordVisibilityBtn = document.getElementById('togglePasswordVisibility');
        const passwordFeedback = document.getElementById('passwordFeedback');
        const startButton = document.getElementById('startButton');
        const googleSignInButton = document.getElementById('googleSignInButton'); // ปุ่ม Google

        // Main Calendar App Elements
        const calendarAppMain = document.getElementById('calendarAppMain');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const eventModal = document.getElementById('eventModal');
        const closeModalBtn = document.getElementById('closeModal');
        const eventForm = document.getElementById('eventForm'); 
        const eventDateInput = document.getElementById('eventDate');
        const eventTitleInput = document.getElementById('eventTitle');
        const eventBookerNameInput = document.getElementById('eventBookerName');
        const eventTimeInput = document.getElementById('eventTime');
        const eventDescriptionInput = document.getElementById('eventDescription');
        const modalTitle = document.getElementById('modalTitle');
        const currentDayEventsContainer = document.getElementById('currentDayEvents');
        const cancelAddEventBtn = document.getElementById('cancelAddEvent');
        const addEventButton = document.getElementById('addEventButton');
        const backToWebsiteBtn = document.getElementById('backToWebsiteBtn');
        const signOutButton = document.getElementById('signOutButton'); // ปุ่มออกจากระบบ

        // Custom Message Modal Elements
        const customMessageModal = document.getElementById('customMessageModal');
        const customMessageTitle = document.getElementById('customMessageTitle');
        const customMessageBody = document.getElementById('customMessageBody');
        const customMessageFooter = document.getElementById('customMessageFooter');
        const closeCustomMessageModalBtn = document.getElementById('closeCustomMessageModal');
        let resolveCustomMessagePromise;

        // Loading Indicator and User ID Display
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('userIdDisplay');

        const COLOR_PALETTE = [
            { name: 'ฟ้า', value: '#3b82f6', tailwind: 'bg-blue-500' },
            { name: 'เขียว', value: '#10b981', tailwind: 'bg-emerald-500' },
            { name: 'แดง', value: '#ef4444', tailwind: 'bg-red-500' },
            { name: 'เหลือง', value: '#eab308', tailwind: 'bg-yellow-500' },
            { name: 'ม่วง', value: '#8b5cf6', tailwind: 'bg-violet-500' },
            { name: 'ส้ม', value: '#f97316', tailwind: 'bg-orange-500' },
            { name: 'ชมพู', value: '#ec4899', tailwind: 'bg-pink-500' },
            { name: 'เทา', value: '#6b7280', tailwind: 'bg-gray-500' },
            { name: 'น้ำตาล', value: '#a16207', tailwind: 'bg-amber-700' }
        ];
        const DEFAULT_EVENT_COLOR = COLOR_PALETTE[0].value;

        let currentActiveDate = new Date();
        let selectedDate = null;
        let allEvents = {}; // Changed to an object to store events grouped by dateKey for easier rendering

        // ตัวอย่างวันสำคัญของไทยและวันหยุดราชการ
        const predefinedHolidays = [
            // วันหยุดราชการ (ตัวอย่างสำหรับปี 2025/2568 - อาจจะต้องปรับวันที่ให้ตรงกับปีปัจจุบันที่คุณใช้งาน)
            { id: 'thai-new-year-2025', date: '2025-01-01', title: 'วันขึ้นปีใหม่', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' }, // สีแดง
            { id: 'makha-bucha-2025', date: '2025-02-12', title: 'วันมาฆบูชา', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'chakri-day-2025', date: '2025-04-06', title: 'วันจักรี', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'songkran-13-2025', date: '2025-04-13', title: 'วันสงกรานต์', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'songkran-14-2025', date: '2025-04-14', title: 'วันสงกรานต์', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'songkran-15-2025', date: '2025-04-15', title: 'วันสงกรานต์', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'labour-day-2025', date: '2025-05-01', title: 'วันแรงงานแห่งชาติ', bookerName: 'วันหยุด (เอกชน/ธนาคาร)', time: '', description: '', color: '#f97316' }, // สีส้ม
            { id: 'coronation-day-2025', date: '2025-05-04', title: 'วันฉัตรมงคล', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'visakha-bucha-2025', date: '2025-05-12', title: 'วันวิสาขบูชา', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'queen-suthida-2025', date: '2025-06-03', title: 'วันเฉลิมพระชนมพรรษาสมเด็จพระราชินี', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'king-rama10-2025', date: '2025-07-28', title: 'วันเฉลิมพระชนมพรรษา ร.10', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'mother-day-2025', date: '2025-08-12', title: 'วันแม่แห่งชาติ', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'chulalongkorn-day-2025', date: '2025-10-23', title: 'วันปิยมหาราช', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'father-day-2025', date: '2025-12-05', title: 'วันคล้ายวันพระบรมราชสมภพ ร.9 / วันพ่อแห่งชาติ', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'constitution-day-2025', date: '2025-12-10', title: 'วันรัฐธรรมนูญ', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
            { id: 'new-year-eve-2025', date: '2025-12-31', title: 'วันสิ้นปี', bookerName: 'วันหยุดราชการ', time: '', description: '', color: '#ef4444' },
        ];

        // ผนวกวันสำคัญเหล่านี้เข้ากับ allEvents
        predefinedHolidays.forEach(event => {
            if (!allEvents[event.date]) {
                allEvents[event.date] = [];
            }
            allEvents[event.date].push(event);
        });


        // Function to render color swatches in the modal
        function renderColorSwatches() {
            const container = document.getElementById('eventColorSelection');
            container.innerHTML = '';

            COLOR_PALETTE.forEach(color => {
                const radioWrapper = document.createElement('label');
                radioWrapper.classList.add('relative', 'cursor-pointer');
                radioWrapper.innerHTML = `
                    <input type="radio" name="eventColor" value="${color.value}" class="hidden peer">
                    <div class="w-8 h-8 rounded-full ${color.tailwind} flex items-center justify-center border-2 border-transparent peer-checked:border-gray-900 transition-all duration-150 ease-in-out">
                        <i class="bi bi-check text-white text-lg hidden peer-checked:block"></i>
                    </div>
                `;
                container.appendChild(radioWrapper);
            });
        }

        // Render the calendar grid
        function renderCalendar() {
            calendarGrid.innerHTML = '';

            // Add day names (Sunday to Saturday)
            const dayNames = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
            dayNames.forEach(dayName => {
                const div = document.createElement('div');
                div.classList.add('day-name');
                div.textContent = dayName;
                calendarGrid.appendChild(div);
            });

            const year = currentActiveDate.getFullYear();
            const month = currentActiveDate.getMonth();

            currentMonthYear.textContent = currentActiveDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric', calendar: 'buddhist' });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);

            const startDayIndex = firstDayOfMonth.getDay();
            const totalDaysInMonth = lastDayOfMonth.getDate();

            const prevMonthLastDay = new Date(year, month, 0).getDate();

            for (let i = 0; i < startDayIndex; i++) {
                const day = document.createElement('div');
                day.classList.add('day', 'other-month');
                day.innerHTML = `<span class="day-number">${prevMonthLastDay - startDayIndex + 1 + i}</span>`;
                calendarGrid.appendChild(day);
            }

            for (let i = 1; i <= totalDaysInMonth; i++) {
                const day = document.createElement('div');
                day.classList.add('day', 'current-month');
                day.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                day.innerHTML = `<span class="day-number">${i}</span>`;

                const today = new Date();
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    day.classList.add('today');
                }

                const eventIndicators = document.createElement('div');
                eventIndicators.classList.add('event-indicators');
                const eventColorDot = document.createElement('div');
                eventColorDot.classList.add('event-color-dot', 'hidden');
                const eventCountSpan = document.createElement('span');
                eventCountSpan.classList.add('event-count', 'hidden');

                eventIndicators.appendChild(eventColorDot);
                eventIndicators.appendChild(eventCountSpan);
                day.appendChild(eventIndicators);

                const dateKey = day.dataset.date;
                if (allEvents[dateKey] && allEvents[dateKey].length > 0) {
                    eventCountSpan.textContent = allEvents[dateKey].length;
                    eventCountSpan.classList.remove('hidden');
                    eventCountSpan.style.backgroundColor = allEvents[dateKey][0].color || DEFAULT_EVENT_COLOR;

                    eventColorDot.style.backgroundColor = allEvents[dateKey][0].color || DEFAULT_EVENT_COLOR;
                    eventColorDot.classList.remove('hidden');
                } else {
                    eventCountSpan.classList.add('hidden');
                    eventColorDot.classList.add('hidden');
                }

                day.addEventListener('click', () => openEventModal(day.dataset.date));
                calendarGrid.appendChild(day);
            }

            const totalCells = startDayIndex + totalDaysInMonth;
            const remainingCells = 42 - totalCells;
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.classList.add('day', 'other-month');
                day.innerHTML = `<span class="day-number">${i}</span>`;
                calendarGrid.appendChild(day);
            }
        }

        // Open event modal for a specific date or for editing an existing event
        function openEventModal(date, eventToEdit = null) {
            selectedDate = date;
            modalTitle.textContent = `งานสำหรับวันที่ ${formatDateForDisplay(date)}`;
            eventDateInput.value = date;
            eventForm.reset();

            renderColorSwatches();

            let initialColor = DEFAULT_EVENT_COLOR;

            if (eventToEdit) {
                eventTitleInput.value = eventToEdit.title;
                eventBookerNameInput.value = eventToEdit.bookerName || '';
                eventTimeInput.value = eventToEdit.time || '';
                eventDescriptionInput.value = eventToEdit.description || '';
                addEventButton.textContent = 'แก้ไขงาน';
                eventForm.dataset.editingId = eventToEdit.id;
                initialColor = eventToEdit.color || DEFAULT_EVENT_COLOR;

            } else {
                addEventButton.textContent = 'เพิ่มงาน';
                delete eventForm.dataset.editingId;
            }

            const selectedColorInput = document.querySelector(`input[name="eventColor"][value="${initialColor}"]`);
            if (selectedColorInput) {
                selectedColorInput.checked = true;
            }

            renderEventsForSelectedDay();
            eventModal.classList.add('show');
        }

        // Format date for display in modal title (e.g., 1 มกราคม 2568)
        function formatDateForDisplay(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric', calendar: 'buddhist' });
        }

        // Render events for the selected day in the modal
        function renderEventsForSelectedDay() {
            currentDayEventsContainer.innerHTML = '<h4>รายการงานสำหรับวันนี้</h4>';
            const eventsForDay = allEvents[selectedDate] || [];

            if (eventsForDay.length === 0) {
                const p = document.createElement('p');
                p.classList.add('no-events-message');
                p.textContent = 'ไม่มีงานสำหรับวันนี้';
                currentDayEventsContainer.appendChild(p);
            } else {
                eventsForDay.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.classList.add('event-item');
                    eventItem.innerHTML = `
                        <div class="event-details">
                            <h4 class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" style="background-color: ${event.color || DEFAULT_EVENT_COLOR};"></span>
                                ${event.title}
                            </h4>
                            <p>ผู้จอง: ${event.bookerName || 'ไม่ระบุ'}</p>
                            ${event.time ? `<p>เวลา: ${event.time}</p>` : ''}
                            ${event.description ? `<p>${event.description}</p>` : ''}
                        </div>
                        <div>
                            <button class="event-edit-btn" data-id="${event.id}"><i class="bi bi-pencil"></i></button>
                            <button class="event-delete-btn" data-id="${event.id}"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                    currentDayEventsContainer.appendChild(eventItem);
                });
            }
        }

        // Custom Alert/Confirm Function
        function showCustomMessage(title, message, type = 'alert') {
            customMessageTitle.textContent = title;
            customMessageBody.textContent = message;
            customMessageFooter.innerHTML = '';

            if (type === 'alert') {
                const okButton = document.createElement('button');
                okButton.classList.add('btn', 'btn-primary');
                okButton.textContent = 'ตกลง';
                okButton.addEventListener('click', () => {
                    customMessageModal.classList.remove('show');
                    if (resolveCustomMessagePromise) {
                        resolveCustomMessagePromise(true);
                    }
                });
                customMessageFooter.appendChild(okButton);
            } else if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.classList.add('btn', 'btn-secondary');
                cancelButton.textContent = 'ยกเลิก';
                cancelButton.addEventListener('click', () => {
                    customMessageModal.classList.remove('show');
                    if (resolveCustomMessagePromise) {
                        resolveCustomMessagePromise(false);
                    }
                });
                customMessageFooter.appendChild(cancelButton);

                const confirmButton = document.createElement('button');
                confirmButton.classList.add('btn', 'btn-danger');
                confirmButton.textContent = 'ยืนยัน';
                confirmButton.addEventListener('click', () => {
                    customMessageModal.classList.remove('show');
                    if (resolveCustomMessagePromise) {
                        resolveCustomMessagePromise(true);
                    }
                });
                customMessageFooter.appendChild(confirmButton);
            }

            customMessageModal.classList.add('show');
            return new Promise(resolve => {
                resolveCustomMessagePromise = resolve;
            });
        }

        // --- Firebase Operations ---

        // Setup Firestore listener for real-time updates
        function setupFirestoreListeners() {
            if (!db) {
                console.error("Firestore not ready.");
                return;
            }

            // เปลี่ยน path ของ Collection ให้เป็นแบบส่วนกลางที่แชร์กัน
            const eventsCollectionRef = collection(db, SHARED_EVENTS_COLLECTION_PATH);

            onSnapshot(eventsCollectionRef, (snapshot) => {
                const fetchedEvents = {};
                snapshot.forEach((doc) => {
                    const eventData = { id: doc.id, ...doc.data() };
                    const dateKey = eventData.date;
                    if (!fetchedEvents[dateKey]) {
                        fetchedEvents[dateKey] = [];
                    }
                    fetchedEvents[dateKey].push(eventData);
                });
                
                // รวม predefined holidays กับข้อมูลจาก Firestore
                allEvents = { ...fetchedEvents }; // เริ่มต้นด้วยข้อมูลจาก Firestore
                predefinedHolidays.forEach(event => {
                    if (!allEvents[event.date]) {
                        allEvents[event.date] = [];
                    }
                    // เพิ่มวันหยุดราชการเข้าไป ถ้ายังไม่มี ID ซ้ำกัน (Firebase data จะมาก่อน)
                    if (!allEvents[event.date].some(e => e.id === event.id)) {
                        allEvents[event.date].push(event);
                    }
                });
                
                renderCalendar(); // Re-render calendar with new data
                if (selectedDate) {
                    renderEventsForSelectedDay(); // Re-render modal events if open
                }
                loadingIndicator.classList.add('hidden'); // ซ่อน loading เมื่อโหลดข้อมูลเสร็จ
            }, (error) => {
                console.error("Error fetching events: ", error);
                showCustomMessage('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลกำหนดการได้: ' + error.message);
                loadingIndicator.classList.add('hidden');
            });
        }

        // Add a new event to Firestore
        async function addEventToFirestore(eventData) {
            try {
                await addDoc(collection(db, SHARED_EVENTS_COLLECTION_PATH), eventData);
            } catch (e) {
                console.error("Error adding document: ", e);
                await showCustomMessage('ข้อผิดพลาด', 'ไม่สามารถเพิ่มงานได้: ' + e.message);
            }
        }

        // Update an existing event in Firestore
        async function updateEventInFirestore(eventId, eventData) {
            try {
                await setDoc(doc(db, SHARED_EVENTS_COLLECTION_PATH, eventId), eventData, { merge: true });
            } catch (e) {
                console.error("Error updating document: ", e);
                await showCustomMessage('ข้อผิดพลาด', 'ไม่สามารถแก้ไขงานได้: ' + e.message);
            }
        }

        // Delete an event from Firestore
        async function deleteEventFromFirestore(eventId) {
            try {
                await deleteDoc(doc(db, SHARED_EVENTS_COLLECTION_PATH, eventId));
            } catch (e) {
                console.error("Error deleting document: ", e);
                await showCustomMessage('ข้อผิดพลาด', 'ไม่สามารถลบงานได้: ' + e.message);
            }
        }


        // --- Event Listeners ---

        // Firebase Initialization and Authentication Logic
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase App
            app = initializeApp(firebaseConfigFromCanvas);
            db = getFirestore(app);
            auth = getAuth(app);

            // Show loading indicator
            loadingIndicator.classList.remove('hidden');

            // Handle authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // เก็บ userId ไว้เผื่อใช้ในอนาคต แต่ไม่ได้ใช้กับ Firestore path แล้ว
                    userIdDisplay.textContent = `User ID: ${currentUserId}`; // สามารถแสดง debug ได้
                    isFirebaseReady = true;
                    // เมื่อผู้ใช้ล็อกอินสำเร็จ ให้แสดงปฏิทินและซ่อนหน้าล็อกอิน
                    preAppScreen.style.display = 'none';
                    calendarAppMain.style.display = 'flex';
                    setupFirestoreListeners(); // Setup listeners after user is authenticated
                } else {
                    // ถ้าผู้ใช้ยังไม่ได้ล็อกอิน ให้แสดงหน้าล็อกอินและซ่อนปฏิทิน
                    preAppScreen.style.display = 'flex';
                    calendarAppMain.style.display = 'none';
                    loadingIndicator.classList.add('hidden'); // ซ่อน loading ถ้ายังไม่ได้ล็อกอิน
                    // ไม่มีการ signInAnonymously อัตโนมัติแล้ว
                }
            });

            // Password visibility toggle
            const togglePasswordIcon = togglePasswordVisibilityBtn ? togglePasswordVisibilityBtn.querySelector('i') : null;
            if (togglePasswordVisibilityBtn && passwordInput && togglePasswordIcon) {
                togglePasswordVisibilityBtn.addEventListener('mousedown', () => {
                    passwordInput.type = 'text';
                    togglePasswordIcon.classList.remove('bi-eye');
                    togglePasswordIcon.classList.add('bi-eye-slash');
                });
                togglePasswordVisibilityBtn.addEventListener('mouseup', () => {
                    passwordInput.type = 'password';
                    togglePasswordIcon.classList.remove('bi-eye-slash');
                    togglePasswordIcon.classList.add('bi-eye');
                });
                togglePasswordVisibilityBtn.addEventListener('mouseout', () => {
                    if (passwordInput.type === 'text') {
                        passwordInput.type = 'password';
                        togglePasswordIcon.classList.remove('bi-eye-slash');
                        togglePasswordIcon.classList.add('bi-eye');
                    }
                });
            }

            // Start button (Password Login) click
            startButton.addEventListener('click', () => {
                if (passwordInput.value === ACCESS_PASSWORD) {
                    // สำหรับ admin ที่ใช้รหัสผ่าน เมื่อเข้ามาแล้วจะถือว่า Authenticated
                    // ในบริบทนี้ จะถือว่าเป็นการเข้าสู่ระบบสำเร็จและ Firebase Auth state จะเปลี่ยนไป
                    // แต่เนื่องจาก Firebase Auth ไม่มีวิธี "authenticate" ด้วยรหัสผ่านแบบง่ายๆ ในฝั่ง client
                    // หากต้องการใช้ระบบ admin password จริงๆ จะต้องมี server-side หรือ Firebase Functions
                    // เพื่อสร้าง Custom Token แล้วใช้ signInWithCustomToken(auth, token)
                    // สำหรับตอนนี้ เราจะแค่แสดงปฏิทินโดยไม่เกี่ยวข้องกับ Firebase Auth state โดยตรง
                    // แต่เพื่อประโยชน์ในการซิงค์ข้อมูล แนะนำให้ admin ล็อกอินด้วย Google แทน
                    // หรือใช้รหัสผ่านเพื่อเข้าสู่ระบบปฏิทินที่ไม่ต้องซิงค์
                    // แต่ถ้าต้องการให้ admin password ล็อกอินแล้วซิงค์ข้อมูลกับคนอื่นได้
                    // คนที่ล็อกอินด้วยรหัสผ่านก็ควรมีการยืนยันตัวตนด้วย Firebase Auth เช่นกัน
                    
                    // **NOTE:** สำหรับตอนนี้ การเข้าสู่ระบบด้วยรหัสผ่านจะแค่แสดงหน้าปฏิทิน
                    // แต่ข้อมูลจะไม่ซิงค์กับคนอื่นที่ล็อกอินด้วย Google หาก Firebase Auth State ไม่ได้เปลี่ยนไป
                    // ทางที่ดีที่สุดคือให้ admin ใช้ Google Sign-In ด้วยเช่นกัน

                    preAppScreen.style.display = 'none';
                    calendarAppMain.style.display = 'flex';
                    loadingIndicator.classList.add('hidden'); // ซ่อน loading เมื่อเข้าได้
                    setupFirestoreListeners(); // โหลดข้อมูลปฏิทิน
                    passwordFeedback.classList.add('hidden');
                } else {
                    passwordFeedback.classList.remove('hidden');
                }
            });

            // Google Sign-In Button click
            googleSignInButton.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    loadingIndicator.classList.remove('hidden');
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged จะจัดการการแสดงผลปฏิทินหลังจากล็อกอินสำเร็จ
                } catch (error) {
                    console.error("Error during Google Sign-in: ", error);
                    let errorMessage = "เกิดข้อผิดพลาดในการเข้าสู่ระบบด้วย Google";
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "คุณปิดหน้าต่างเข้าสู่ระบบก่อนที่จะเสร็จสิ้น";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = "มีคำขอเข้าสู่ระบบ Google ซ้อนกัน โปรดลองอีกครั้ง";
                    }
                    await showCustomMessage('ข้อผิดพลาด', errorMessage + ": " + error.message);
                    loadingIndicator.classList.add('hidden');
                }
            });

            // Enter key on password input
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startButton.click();
                }
            });
        });

        // Calendar Navigation Buttons
        prevMonthBtn.addEventListener('click', () => {
            currentActiveDate.setMonth(currentActiveDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentActiveDate.setMonth(currentActiveDate.getMonth() + 1);
            renderCalendar();
        });

        // Event Modal Buttons
        closeModalBtn.addEventListener('click', () => {
            eventModal.classList.remove('show');
        });

        cancelAddEventBtn.addEventListener('click', () => {
            eventModal.classList.remove('show');
        });

        // Add/Edit Event Form Submission
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = eventDateInput.value;
            const title = eventTitleInput.value;
            const bookerName = eventBookerNameInput.value;
            const time = eventTimeInput.value;
            const description = eventDescriptionInput.value;
            const selectedColor = document.querySelector('input[name="eventColor"]:checked')?.value || DEFAULT_EVENT_COLOR;

            if (!title) {
                await showCustomMessage('ข้อผิดพลาด', 'กรุณากรอกชื่องาน <span class="text-red-500">*</span>');
                return;
            }
            if (!bookerName) {
                await showCustomMessage('ข้อผิดพลาด', 'กรุณากรอกชื่อผู้จอง <span class="text-red-500">*</span>');
                return;
            }

            const eventData = {
                date,
                title,
                bookerName,
                time,
                description,
                color: selectedColor,
                // สามารถเพิ่มข้อมูลผู้สร้าง/แก้ไขงานได้ เช่น createdBy: auth.currentUser.email
            };

            const editingId = eventForm.dataset.editingId;

            if (editingId) {
                await updateEventInFirestore(editingId, eventData);
            } else {
                await addEventToFirestore(eventData);
            }

            eventModal.classList.remove('show'); // Close modal after submission
            // renderCalendar() and renderEventsForSelectedDay() are called by onSnapshot
        });

        // Event delegation for deleting and editing events
        currentDayEventsContainer.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.event-delete-btn');
            const editButton = e.target.closest('.event-edit-btn');

            if (deleteButton) {
                const eventIdToDelete = deleteButton.dataset.id;
                const confirmed = await showCustomMessage('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?', 'confirm');
                
                if (confirmed) {
                    await deleteEventFromFirestore(eventIdToDelete);
                }
            } else if (editButton) {
                const eventIdToEdit = editButton.dataset.id;
                // Find the event in the current allEvents structure
                const eventToEdit = (allEvents[selectedDate] || []).find(event => event.id === eventIdToEdit);
                if (eventToEdit) {
                    openEventModal(selectedDate, eventToEdit);
                }
            }
        });

        // Close custom message modal when clicking its close button
        closeCustomMessageModalBtn.addEventListener('click', () => {
            customMessageModal.classList.remove('show');
            if (resolveCustomMessagePromise) {
                resolveCustomMessagePromise(false);
            }
        });

        // Event Listener for the new "Back to Website" button
        backToWebsiteBtn.addEventListener('click', () => {
            window.location.href = TEAM_WEBSITE_URL;
        });

        // Sign Out Button
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged จะจัดการการแสดงหน้าล็อกอินหลังจากออกจากระบบ
            } catch (error) {
                console.error("Error signing out:", error);
                await showCustomMessage('ข้อผิดพลาด', 'ไม่สามารถออกจากระบบได้: ' + error.message);
            }
        });

    </script>
</body>
</html>
